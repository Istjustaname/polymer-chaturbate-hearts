<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-icons/iron-icons.html">

<dom-module id="chaturbate-hearts">

  <template>
    <style>
      :host {
        --cb-moderator-color: #DC0000;
        --cb-fanclub-color: #090;
        --cb-tipped-tons-color: #804baa;
        --cb-tipped-alot-color: #be6aff;
        --cb-tipped-color: #009;
        --cb-has-tokens-color: #69A;
      }

      .heart {
        opacity: 1;
        position: absolute;
        bottom: 0;
        display: none;
        animation-iteration-count: 1;
      }

      .heart iron-icon {
        position: absolute;
        right: 0;
        top: 0;
        opacity: .9;
      }

      .heart iron-icon.enormous {
        --iron-icon-height: 256px;
        --iron-icon-width: 256px;
      }
      .heart iron-icon.large {
        --iron-icon-height: 160px;
        --iron-icon-width: 160px;
      }
      .heart iron-icon.medium {
        --iron-icon-height: 96px;
        --iron-icon-width: 96px;
      }
      .heart iron-icon.small {
        --iron-icon-height: 64px;
        --iron-icon-width: 64px;
      }
      .heart iron-icon.tiny {
        --iron-icon-height: 32px;
        --iron-icon-width: 32px;
      }
      
      .user-moderator {
        color: var(--cb-moderator-color);
      }
      .user-fanclub {
        color: var(--cb-fanclub-color);
      }
      .user-tipped-tons {
        color: var(--cb-tipped-tons-color);
      }
      .user-tipped-alot {
        color: var(--cb-tipped-alot-color);
      }
      .user-tipped {
        color: var(--cb-tipped-color);
      }
      .user-has-tokens {
        color: var(--cb-has-tokens-color);
      }
      
      @keyframes flowOne {
        0% {
          opacity: 0;
          bottom: 0;
          right: 14%
        }
        40% {
          opacity: .8;
        }
        50% {
          opacity: 1;
          right: 0;
        }
        60% {
          opacity: .2;
        }
        80% {
          bottom: 80%
        }
        100% {
          opacity: 0;
          bottom: 100%;
          right: 18%
        }
      }
      
      @keyframes flowTwo {
        0% {
          opacity: 0;
          bottom: 0;
          right: 0;
        }
        40% {
          opacity: .8;
        }
        50% {
          opacity: 1;
          right: 11%
        }
        60% {
          opacity: .2;
        }
        80% {
          bottom: 60%
        }
        100% {
          opacity: 0;
          bottom: 80%;
          right: 0;
        }
      }
      
      @keyframes flowThree {
        0% {
          opacity: 0;
          bottom: 0;
          right: 0;
        }
        40% {
          opacity: .8;
        }
        50% {
          opacity: 1;
          right: 30%
        }
        60% {
          opacity: .2;
        }
        80% {
          bottom: 70%
        }
        100% {
          opacity: 0;
          bottom: 90%;
          right: 0;
        }
      }
    </style>

    <template is="dom-repeat" items="{{hearts}}">
      <div class$="heart [[_getColorClass(item)]]"
            style$="animation: [[_getAnimation(item)]] [[_getAnimationTime(item)]]s linear;
                    display: block;">
        <iron-icon icon="icons:favorite" class$="[[_getIconSizeClass(item)]]"></iron-icon>
      </div>
    </template>
  </template>

  <script>
    class ChaturbateHearts extends Polymer.Element {
      static get is() {
        return 'chaturbate-hearts';
      }

      static get properties() {
        return {
          hearts: {
            type: Array,
            value: [],
            notify: true
          },
          minTimeout: {
            type: Number,
            value: 1.2
          },
          maxTimeout: {
            type: Number,
            value: 1.6
          }
        }
      }

      static get flows() {
        return [
          'flowOne',
          'flowTwo',
          'flowThree'
        ];
      }

      _getColorClass(item) {
        if (item.user.isMod) return 'user-moderator';
        if (item.user.inFanclub) return 'user-fanclub';
        if (item.user.tippedTonsRecently) return 'user-tipped-tons';
        if (item.user.tippedAlotRecently) return 'user-tipped-alot';
        if (item.user.tippedRecently) return 'user-tipped';
        if (item.user.hasTokens) return 'user-has-tokens';
      }

      _getIconSizeClass(item) {
        if (item.amount >= 1000) return 'enormous';
        if (item.amount >= 500) return 'large';
        if (item.amount >= 100) return 'medium';
        if (item.amount >= 15) return 'small';
        return 'tiny';
      }

      _getAnimation(item) {
        const index = Math.floor((Math.random() * ChaturbateHearts.flows.length));
        return ChaturbateHearts.flows[index];
      }

      _getAnimationTime(item) {
        return this._getAnimationTimeValue(item) * this._getAnimationTimeSeed();
      }

      _getAnimationTimeValue(item) {
        if (item.amount >= 1000) return 16;
        if (item.amount >= 500) return 8;
        if (item.amount >= 100) return 4;
        if (item.amount >= 15) return 2;
        return 1;
      }

      _getAnimationTimeSeed() {
        return (Math.random() * (this.maxTimeout - this.minTimeout) + this.minTimeout).toFixed(1);
      }

      hide(params) {
        const index = this.hearts.indexOf(params);
        this.splice('hearts', index, 1);
      }

      show(params) {
        this.push('hearts', params);
        const timeout = this._getAnimationTimeValue(params) * this.maxTimeout * 1000;
        setTimeout(() => this.hide(params), timeout);
      }
    }

    window.customElements.define(ChaturbateHearts.is, ChaturbateHearts);
  </script>
</dom-module>
